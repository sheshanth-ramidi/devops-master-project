---
- name: Configure EC2 for Docker + AWS CLI (FINAL FINAL)
  hosts: web
  become: yes
  gather_facts: yes
 
  tasks:
 
    - name: Wait for cloud-init
      shell: |
        while [ ! -f /var/lib/cloud/instance/boot-finished ]; do
          sleep 5
        done
 
    - name: Remove apt locks completely
      shell: |
        systemctl stop apt-daily.service apt-daily-upgrade.service || true
        systemctl kill apt-daily.service apt-daily-upgrade.service || true
        rm -f /var/lib/apt/lists/lock
        rm -f /var/cache/apt/archives/lock
        rm -f /var/lib/dpkg/lock*
        dpkg --configure -a
 
    - name: Install base packages
      shell: |
        apt-get update -y
        apt-get install -y ca-certificates curl gnupg lsb-release unzip
 
    - name: Add Docker official GPG key
      shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
 
    - name: Add Docker official repository
      shell: |
        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
        https://download.docker.com/linux/ubuntu \
        $(lsb_release -cs) stable" \
        > /etc/apt/sources.list.d/docker.list
 
    - name: Update apt cache after adding Docker repo
      shell: |
        apt-get update -y
 
    - name: Install Docker CE
      shell: |
        apt-get install -y docker-ce docker-ce-cli containerd.io
 
    - name: Start and enable Docker
      shell: |
        systemctl enable docker
        systemctl start docker
 
    - name: Add ubuntu user to docker group
      shell: |
        usermod -aG docker ubuntu
 
    - name: Install AWS CLI v2
      shell: |
        curl -sSL https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o /tmp/awscliv2.zip
        unzip -o /tmp/awscliv2.zip -d /tmp
        /tmp/aws/install || true
 
    - name: Verify Docker
      command: docker --version
      register: docker_out
 
    - debug:
        msg: "{{ docker_out.stdout }}"
 
    - name: Verify AWS CLI
      command: aws --version
      register: aws_out
 
    - debug:
        msg: "{{ aws_out.stdout }}"
