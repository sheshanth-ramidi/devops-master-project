---
- name: Configure EC2 for Docker + AWS CLI (FINAL FIX)
  hosts: web
  become: yes
  gather_facts: yes
 
  tasks:
 
    - name: Wait for cloud-init
      shell: |
        while [ ! -f /var/lib/cloud/instance/boot-finished ]; do
          sleep 5
        done
 
    - name: Kill any apt locks (hard stop)
      shell: |
        killall apt apt-get dpkg || true
        rm -f /var/lib/dpkg/lock-frontend
        rm -f /var/lib/apt/lists/lock
        dpkg --configure -a
 
    - name: Install software-properties-common (required)
      shell: |
        apt-get update -y
        apt-get install -y software-properties-common
 
    - name: Enable universe repository (SAFE WAY)
      shell: |
        add-apt-repository universe -y
 
    - name: Update apt cache (force)
      shell: |
        apt-get update -y
 
    - name: Install Docker
      shell: |
        apt-get install -y docker.io
 
    - name: Start and enable Docker
      shell: |
        systemctl start docker
        systemctl enable docker
 
    - name: Add ubuntu user to docker group
      shell: |
        usermod -aG docker ubuntu
 
    - name: Download AWS CLI v2
      shell: |
        curl -sSL https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o /tmp/awscliv2.zip
 
    - name: Install AWS CLI
      shell: |
        unzip -o /tmp/awscliv2.zip -d /tmp
        /tmp/aws/install || true
 
    - name: Verify Docker
      command: docker --version
      register: docker_out
 
    - debug:
        msg: "{{ docker_out.stdout }}"
 
    - name: Verify AWS CLI
      command: aws --version
      register: aws_out
 
    - debug:
        msg: "{{ aws_out.stdout }}"
