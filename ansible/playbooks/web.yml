---
- name: Configure EC2 for Docker + AWS CLI
  hosts: web
  become: yes
  gather_facts: yes
 
  tasks:
 
    # ---------------------------------------------------
    # Wait for cloud-init (MANDATORY on EC2)
    # ---------------------------------------------------
    - name: Wait for cloud-init to finish
      shell: |
        while [ ! -f /var/lib/cloud/instance/boot-finished ]; do
          sleep 5
        done
 
    # ---------------------------------------------------
    # Kill apt locks HARD
    # ---------------------------------------------------
    - name: Stop apt services
      shell: |
        systemctl stop apt-daily.service || true
        systemctl stop apt-daily.timer || true
        systemctl stop unattended-upgrades || true
 
    - name: Remove apt lock files
      shell: |
        rm -f /var/lib/apt/lists/lock
        rm -f /var/cache/apt/archives/lock
        rm -f /var/lib/dpkg/lock*
        dpkg --configure -a
 
    # ---------------------------------------------------
    # Enable universe (NON-INTERACTIVE)
    # ---------------------------------------------------
    - name: Enable universe repository
      shell: add-apt-repository -y universe
 
    # ---------------------------------------------------
    # Update apt cache (SHELL â€” NOT apt module)
    # ---------------------------------------------------
    - name: Update apt cache safely
      shell: |
        apt-get clean
        apt-get update -y
 
    # ---------------------------------------------------
    # Install packages
    # ---------------------------------------------------
    - name: Install required packages
      shell: |
        apt-get install -y docker.io unzip curl
 
    # ---------------------------------------------------
    # Docker setup
    # ---------------------------------------------------
    - name: Start Docker
      shell: |
        systemctl enable docker
        systemctl start docker
 
    - name: Add ubuntu user to docker group
      shell: |
        usermod -aG docker ubuntu
 
    # ---------------------------------------------------
    # AWS CLI v2
    # ---------------------------------------------------
    - name: Install AWS CLI v2
      shell: |
        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
        unzip -o /tmp/awscliv2.zip -d /tmp
        /tmp/aws/install || true
 
    # ---------------------------------------------------
    # Verify
    # ---------------------------------------------------
    - name: Verify AWS CLI
      shell: aws --version
 
    - name: Verify IAM Role
      shell: aws sts get-caller-identity
